<!doctype html>
<html lang="en">
<head>
    <title>Alaska Earthquake Map - Shapes</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

    <style>
        body { margin:0; padding:0; }
        #mapdiv { height: 100vh; width: 100vw; }

        .legend {
            background: white; padding: 10px 12px; line-height: 22px; color: #333;
            border-radius: 6px; box-shadow: 0 0 15px rgba(0,0,0,0.2); width: 200px;
        }
        .legend h4 { margin: 0 0 6px; font-size: 14px; font-weight: bold; }
        /* Style for the shape icons in the legend */
        .legend svg { vertical-align: middle; margin-right: 8px; }
        
        /* Ensures the divIcon background is transparent */
        .custom-shape-icon { background: none; border: none; }
    </style>
</head>
<body>

<div id="mapdiv"></div>

<script>
    var map = L.map('mapdiv').setView([58.0, -150.0], 5);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap'
    }).addTo(map);

    // Helper to get shape and color based on depth
    function getShapeData(depth, size) {
        if (depth <= 40) {
            // Yellow Triangle
            return `<polygon points="${size},0 0,${size*2} ${size*2},${size*2}" fill="#ffff66" stroke="black" stroke-width="1"/>`;
        } else if (depth <= 90) {
            // Blue Square
            return `<rect width="${size*2}" height="${size*2}" fill="#3399ff" stroke="black" stroke-width="1"/>`;
        } else if (depth <= 140) {
            // Orange Circle
            return `<circle cx="${size}" cy="${size}" r="${size}" fill="#ff9933" stroke="black" stroke-width="1"/>`;
        } else {
            // Purple Star
            return `<polygon points="${size},0 ${size*0.2},${size*1.9} ${size*1.9},${size*0.7} ${size*0.1},${size*0.7} ${size*1.8},${size*1.9}" fill="#9933cc" stroke="black" stroke-width="1"/>`;
        }
    }

    var combinedLegend = L.control({ position: "bottomright" });
    combinedLegend.onAdd = function (map) {
        var div = L.DomUtil.create("div", "info legend");
        div.innerHTML = `
            <h4>Earthquake Depth</h4>
            <svg width="18" height="18"><polygon points="9,2 2,16 16,16" fill="#ffff66" stroke="black"/></svg> 0–40 km (Triangle)<br>
            <svg width="18" height="18"><rect width="14" height="14" x="2" y="2" fill="#3399ff" stroke="black"/></svg> 40–90 km (Square)<br>
            <svg width="18" height="18"><circle cx="9" cy="9" r="7" fill="#ff9933" stroke="black"/></svg> 90–140 km (Circle)<br>
            <svg width="18" height="18"><polygon points="9,1 2,16 17,6 1,6 16,16" fill="#9933cc" stroke="black"/></svg> > 140 km (Star)
        `;
        return div;
    };
    combinedLegend.addTo(map);

    Papa.parse("Alaska Earthquakes to Print.csv", {
        download: true,
        header: true,
        dynamicTyping: true,
        complete: function(results) {
            results.data.forEach(function(eq) {
                const lat = eq.latitude;
                const lon = eq.longitude;
                const mag = eq.mag;
                const depth = eq.depth;

                if (!isFinite(lat) || !isFinite(lon)) return;

                // Scale size by magnitude
                const size = Math.max(mag * 3, 5); 

                // Create custom SVG icon
                var icon = L.divIcon({
                    className: 'custom-shape-icon',
                    html: `<svg width="${size*2}" height="${size*2}" viewBox="0 0 ${size*2} ${size*2}">${getShapeData(depth, size)}</svg>`,
                    iconSize: [size*2, size*2],
                    iconAnchor: [size, size] // Centers the shape
                });

                L.marker([lat, lon], { icon: icon })
                .bindPopup(`<b>Magnitude:</b> ${mag}<br><b>Depth:</b> ${depth} km`)
                .addTo(map);
            });
        }
    });
</script>
</body>
</html>