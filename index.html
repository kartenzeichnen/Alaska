<!doctype html>
<html lang="en">
<head>
    <title>Alaska Earthquake Map</title>

    <!-- Leaflet CSS: Essential for map styling and marker placement -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <!-- Leaflet JS: The engine that creates the interactive map -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- PapaParse: A library used to read and convert CSV files into JavaScript objects -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

    <style>
        /* Make the map fill the entire browser window */
        body { margin:0; padding:0; }
        #mapdiv { height: 100vh; width: 100vw; }

        /* Styling for the Legend box in the bottom right */
        .legend {
            background: white;
            padding: 10px 12px;
            line-height: 18px;
            color: #333;
            border-radius: 6px;
            box-shadow: 0 0 15px rgba(0,0,0,0.2);
            width: 180px;
            font-size: 13px;
        }

        .legend h4 { margin: 0 0 6px; font-size: 14px; font-weight: bold; }
        .legend .divider { border-top: 1px solid #ccc; margin: 8px 0; }

        /* Small colored squares in the legend representing depth */
        .legend i {
            width: 18px;
            height: 18px;
            float: left;
            margin-right: 8px;
            opacity: 0.8;
        }

        /* Circles in the legend representing magnitude size */
        .legend .circle {
            display: inline-block;
            border-radius: 50%;
            background: #666;
            opacity: 0.7;
            margin-right: 8px;
            vertical-align: middle;
        }

        /* Container for the SVG Compass Rose */
        .compass-rose {
            background: white;
            padding: 6px;
            border-radius: 6px;
            box-shadow: 0 0 8px rgba(0,0,0,0.3);
        }
    </style>
</head>
<body>

<!-- The container where the map will be injected -->
<div id="mapdiv"></div>

<script>
    /* 1. INITIALIZE MAP: Set center to Alaska [Lat, Lon] and zoom level to 6 */
    var map = L.map('mapdiv').setView([58.0, -150.0], 6);

    /* 2. BASE LAYER: Load OpenStreetMap tiles so we have a visible map background */
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 18,
        attribution: '&copy; <a href="https://www.openstreetmap.org">OpenStreetMap</a>'
    }).addTo(map);






/* 3. INTERACTIVE SCALE WITH COMPASS SYNC */
var CustomScale = L.Control.extend({
    options: { position: 'bottomleft' },
    unitMode: 'km', 

    onAdd: function (map) {
        var self = this;
        var container = L.DomUtil.create('div', 'leaflet-control-scale custom-graduated-scale');
        
        container.style.background = 'rgba(255,255,255,0.95)';
        container.style.padding = '12px';
        container.style.border = '2px solid #333';
        container.style.fontSize = '12px';
        container.style.fontFamily = 'Arial, sans-serif';
        container.style.borderRadius = '6px';
        container.style.cursor = 'pointer';

        var update = function () {
            var center = map.getCenter();
            var isKm = self.unitMode === 'km';
            
            var targetDist = isKm ? 400 : 240; 
            var unitLabel = isKm ? 'km' : 'mi';
            var primaryColor = isKm ? '#000000' : '#0055ff'; // Black for KM, Blue for MI
            var accentColor = isKm ? '#cc3333' : '#0055ff';  // Red for KM, Blue for MI
            
            // Sync the compass color
            compassRose.updateColor(accentColor);

            var p1 = map.latLngToContainerPoint(center);
            var p2 = map.latLngToContainerPoint(L.latLng(center.lat, center.lng + (targetDist / (111.32 * Math.cos(center.lat * Math.PI / 180)))));
            var pixelWidth = Math.abs(p2.x - p1.x);
            var interval = targetDist / 4;

            container.innerHTML = `
                <div style="font-weight:bold; margin-bottom: 22px; text-align: center; color: ${primaryColor};">
                    Alaska Scale (${isKm ? 'Kilometers' : 'Miles'})
                </div>
                <div style="position: relative; width:${pixelWidth}px; height:14px; border:1px solid #000; display:flex;">
                    <span style="position:absolute; left:0; top:-18px; font-weight:bold;">0 ${unitLabel}</span>
                    <div style="flex:1; background:${primaryColor}; border-right:1px solid #000; position:relative;"><span style="position:absolute; right:-12px; top:-18px;">${interval*1}</span></div>
                    <div style="flex:1; background:#ffffff; border-right:1px solid #000; position:relative;"><span style="position:absolute; right:-12px; top:-18px;">${interval*2}</span></div>
                    <div style="flex:1; background:${primaryColor}; border-right:1px solid #000; position:relative;"><span style="position:absolute; right:-12px; top:-18px;">${interval*3}</span></div>
                    <div style="flex:1; background:#ffffff; position:relative;"><span style="position:absolute; right:-12px; top:-18px;">${interval*4}</span></div>
                </div>
                <div style="margin-top: 10px; font-size: 11px; text-align: center; border-top: 1px solid #ccc; padding-top: 4px; color: #666;">
                    Click scale to toggle (Black/Blue)
                </div>
            `;
        };

        L.DomEvent.on(container, 'click', function(e) {
            L.DomEvent.stopPropagation(e);
            self.unitMode = (self.unitMode === 'km') ? 'mi' : 'km';
            update();
        });

        map.on('zoomend moveend', update);
        update();
        return container;
    }
});
map.addControl(new CustomScale());









/* 4. COMPASS ROSE: Now a global variable so we can update it */
var compassRose = L.control({ position: 'topright' });

compassRose.onAdd = function (map) {
    this._div = L.DomUtil.create('div', 'compass-rose');
    this.updateColor('#cc3333'); // Initial Red color
    return this._div;
};

// Custom method to swap the accent color of the compass
compassRose.updateColor = function (newColor) {
    this._div.innerHTML = `
    <svg width="80" height="80" viewBox="0 0 200 200" aria-label="Compass Rose">
        <circle cx="100" cy="100" r="95" fill="white" stroke="black" stroke-width="3"/>
        <g transform="translate(100 100)">
            <g fill="black"> <!-- Cardinal Points -->
                <polygon points="0,-80 -10,0 0,-15 10,0"/>
                <polygon points="80,0 0,-10 15,0 0,10"/>
                <polygon points="0,80 -10,0 0,15 10,0"/>
                <polygon points="-80,0 0,-10 -15,0 0,10"/>
            </g>
            <g fill="${newColor}"> <!-- Dynamic Accent Color (Red or Blue) -->
                <g transform="rotate(45)"><polygon points="0,-60 -7,0 0,-12 7,0"/></g>
                <g transform="rotate(135)"><polygon points="0,-60 -7,0 0,-12 7,0"/></g>
                <g transform="rotate(225)"><polygon points="0,-60 -7,0 0,-12 7,0"/></g>
                <g transform="rotate(315)"><polygon points="0,-60 -7,0 0,-12 7,0"/></g>
            </g>
        </g>
        <text x="100" y="30" text-anchor="middle" font-size="18" font-weight="bold">N</text>
        <text x="170" y="105" text-anchor="middle" font-size="16">E</text>
        <text x="100" y="185" text-anchor="middle" font-size="16">S</text>
        <text x="30" y="105" text-anchor="middle" font-size="16">W</text>
        <circle cx="100" cy="100" r="4" fill="black"/>
    </svg>`;
};
compassRose.addTo(map);










    /* 5. HELPER FUNCTION: Returns a color hex code based on the earthquake's depth */
    function getColor(depth) {
        if (depth <= 40) return "#ffff66";   // Shallow = Yellow
        if (depth <= 90) return "#3399ff";   // Moderate = Blue
        if (depth <= 140) return "#ff9933";  // Deep = Orange
        return "#9933cc";                    // Very Deep = Purple
    }

    /* 6. LEGEND: Create the box that explains colors and circle sizes */
    var combinedLegend = L.control({ position: "bottomright" });

    combinedLegend.onAdd = function (map) {
        var div = L.DomUtil.create("div", "info legend");
        var mags = [3, 5, 7]; // Example magnitudes to show in legend

        div.innerHTML = `
            <h4>Earthquake Depth (km)</h4>
            <i style="background:#ffff66"></i> 0–40<br>
            <i style="background:#3399ff"></i> 40.1–90<br>
            <i style="background:#ff9933"></i> 90.1–140<br>
            <i style="background:#9933cc"></i> > 140.1
            <div class="divider"></div>
            <h4>Magnitude</h4>
        `;

        // Loop through the example magnitudes to create visual circle size indicators


       mags.forEach(function (m) {
            // NEW SCALING: Using power of 1.7 for dramatic visual difference
            var size = Math.pow(m, 1.7); 
            div.innerHTML += `
                <div style="margin-bottom: 8px;">
                    <span class="circle" style="width:${size * 2}px; height:${size * 2}px;"></span>
                    M ${m}
                </div>`;
        });
        return div;


    };
    combinedLegend.addTo(map);

    /* 7. DATA LOADING: Use PapaParse to fetch and read the external CSV file */
    Papa.parse("Alaska Earthquakes to Print.csv", {
        download: true,
        header: true,
        dynamicTyping: true, // Automatically converts strings to numbers
        complete: function(results) {
            
            // Loop through every row in the CSV
            results.data.forEach(function(eq) {
                // Map CSV columns to variables
                const lat = Number(eq.latitude);
                const lon = Number(eq.longitude);
                const mag = Number(eq.mag);
                const depth = Number(eq.depth);

                // DATA VALIDATION: Skip rows that have missing or broken numbers
                if (!isFinite(lat) || !isFinite(lon) || !isFinite(mag) || !isFinite(depth)) {
                    return;
                }

                /* 8. MAPPING: Create a circle marker for each earthquake */


               L.circleMarker([lat, lon], {
                    radius: Math.pow(mag, 1.7), // Pronounced scaling
                    color: getColor(depth),
                    fillOpacity: 0.6,           // Slightly lowered to see overlapping markers
                    weight: 1                   // Thin border for clarity
                })
                .bindPopup(`<b>Magnitude:</b> ${mag}<br><b>Depth:</b> ${depth} km`)
                .addTo(map);




            });
        }
    });
</script>

</body>
</html>